name: ✨ Build and Push Images ✨

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (staging or prod)'
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      K3S_CONFIG_TOKEN:
        required: true

jobs:
  build-push_backend:
    name: Build and push the backend image
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.11'
    steps:
      - name: 📥 Checkout Code (choremane)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 🐍 Python setup + cache
      - name: 🐍 Setup Python & Cache Deps
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: 📦 Install Python Deps
        run: pip install -r backend/requirements.txt

      - name: 🔧 Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 🔑 Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🏭 Build & Push Backend
        id: build_backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.repository_owner }}/choremane-backend:latest
            ${{ github.repository_owner }}/choremane-backend:${{ github.sha }}

  build-push_frontend:
    name: Build and push the frontend image
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      NODE_VERSION: '18'
    steps:
      - name: 📥 Checkout Code (choremane)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 🌐 Node setup + cache
      - name: 🌐 Setup Node & Cache Deps
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: 📦 Install Node Deps
        working-directory: ./frontend
        run: npm install

      - name: 🔧 Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 🔑 Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🏭 Build & Push Frontend
        id: build_frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.repository_owner }}/choremane-frontend:latest
            ${{ github.repository_owner }}/choremane-frontend:${{ github.sha }}
